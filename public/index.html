<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Seyori’s Contact Database</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0d0f10;--panel:#0b0e0b;--fg:#c4f5c4;--muted:#6ee76e;--accent:#54ff54;--accent-2:#00f5ff;
      --border:#1e241e;--input-bg:#0f1410;--error:#ff5c5c;--ok:#7aff7a;--whatsapp:#25D366;--wa-dark:#075E54;
      --shadow:0 0 20px rgba(84,255,84,.12), inset 0 0 10px rgba(84,255,84,.08)
    }
    *{box-sizing:border-box}
    body{
      margin:0;background:
        radial-gradient(1200px 800px at 10% -10%, rgba(84,255,84,.08), transparent 60%),
        radial-gradient(1200px 800px at 110% 10%, rgba(0,245,255,.06), transparent 55%),
        var(--bg);
      color:var(--fg);
      font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Courier New", monospace;
      font-size:14px; line-height:1.55;
    }
    .wrap{max-width:1200px;margin:0 auto;padding:1.2rem}
    .columns{display:grid;grid-template-columns:repeat(auto-fit,minmax(340px,1fr));gap:1.2rem;align-items:start}

    .card{
      border:1px solid var(--border);border-radius:12px;padding:1rem;
      background:linear-gradient(180deg,rgba(0,0,0,.08),transparent),var(--panel);
      box-shadow:var(--shadow);transition:opacity .25s ease, filter .25s ease
    }
    .card.locked{opacity:.4;filter:saturate(.6);pointer-events:none;user-select:none}

    h1,h2{margin:0 0 .55rem 0}
    h1{font-size:1.25rem}
    h2{font-size:1.1rem}
    .sub{color:var(--muted);margin:0 0 .7rem 0;opacity:.95;max-width:70ch}

    label{display:block;margin:.45rem 0 .25rem;color:var(--muted)}
    input,select,button{
      width:100%;padding:.75rem;border-radius:8px;border:1px solid var(--border);
      background:var(--input-bg);color:var(--fg);outline:none;font-size:.92rem
    }
    input:focus,select:focus{border-color:var(--accent);box-shadow:0 0 0 2px rgba(84,255,84,.2)}
    select{min-height:44px;cursor:pointer}

    .row{display:flex;gap:.7rem;align-items:center}
    .row>*{flex:1}

    .form-grid{display:grid;grid-template-columns:1fr 1fr;gap:1rem;align-items:end}
    @media (max-width:760px){.form-grid{grid-template-columns:1fr}}

    button{cursor:pointer;margin-top:.65rem;font-weight:700;letter-spacing:.2px;transition:transform .12s ease, box-shadow .2s ease, opacity .2s ease}
    button:hover{transform:translateY(-1px);box-shadow:0 8px 18px rgba(84,255,84,.25)}
    button:disabled{cursor:not-allowed;opacity:.6;box-shadow:none;transform:none}
    .primary{background:var(--accent);color:#002b00;border-color:var(--accent)}
    .neon{padding:.9rem 1rem;border-radius:10px;border:1px solid var(--accent-2);background:#0a0a0a;color:#eaffff;font-weight:800;box-shadow:0 0 10px rgba(0,245,255,.5), inset 0 0 10px rgba(0,245,255,.15)}
    .whatsapp{background:var(--whatsapp);color:#fff;border-color:var(--whatsapp)}
    .whatsapp-dark{background:var(--wa-dark);color:#fff;border-color:var(--wa-dark)}
    .telegram{background:#229ED9;color:#fff;border-color:#229ED9}

    .muted{color:var(--muted);font-size:.85rem}
    .pill{display:inline-block;background:rgba(84,255,84,.1);border:1px solid var(--border);padding:.35rem .7rem;border-radius:999px;font-weight:700;font-size:.85rem}
    .error{color:var(--error);margin:.6rem 0;padding:.45rem;border-radius:6px;background:rgba(255,92,92,.1)}
    .success{color:var(--ok);margin:.6rem 0;padding:.45rem;border-radius:6px;background:rgba(84,255,84,.1)}
    .footer{margin-top:1rem;text-align:center;padding-top:1rem;border-top:1px dashed var(--border)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="columns">

      <section class="card">
        <h1>Contact Gain</h1>
        <p class="sub">Join the WhatsApp group, add your number, and download the contacts file when the timer runs out.</p>
        <div class="pill">Contacts in database: <strong id="contactCount">0</strong></div>
      </section>

      <section class="card" id="gateCard">
        <h2>Step 1 — Join the WhatsApp Group</h2>
        <div class="row">
          <a id="joinLink" href="https://chat.whatsapp.com/BLKWk1RyJ2BIgSZAPl9QlB?mode=ems_copy_t" target="_blank" rel="noopener">
            <button class="whatsapp-dark">Join Group</button>
          </a>
          <a id="tgLink" href="https://t.me/friendsandfamilyyyyyy" target="_blank" rel="noopener">
            <button class="telegram">Join Telegram</button>
          </a>
          <button type="button" id="verifyBtn" class="primary">Verify Joined</button>
        </div>
        <div id="gateMsg" class="muted" style="margin-top:.5rem">
          Tap each join button twice (WhatsApp ×2 and Telegram ×2), then hit <strong>Verify Joined</strong>.
        </div>
      </section>

      <section class="card locked" id="step2">
        <h2>Step 2 — Save Your Contact</h2>
        <p class="muted">Select your country code, input your number then your name.</p>
        <div id="message"></div>

        <form id="contactForm" autocomplete="off">
          <div class="form-grid">
            <div>
              <label for="ccSelect">Country code</label>
              <select id="ccSelect" name="ccSelect" disabled></select>
            </div>
            <div id="customCodeWrap" style="display:none">
              <label for="ccCustom">Custom code</label>
              <input id="ccCustom" inputmode="numeric" pattern="\d+" placeholder="e.g. 234" />
            </div>

            <div>
              <label for="number">Phone number</label>
              <input id="number" name="number" placeholder="7025369036" required disabled />
            </div>
            <div>
              <label for="fullName">Your name</label>
              <input id="fullName" name="fullName" placeholder="Seyori" required disabled />
            </div>
          </div>

          <button type="submit" id="saveBtn" class="primary" disabled>Save contact</button>
        </form>
      </section>

      <section class="card locked" id="step3">
        <h2>Step 3 — Download Contacts File (VCF)</h2>
        <p class="muted">Will be available for download after the timer runs out.</p>
        <button type="button" id="downloadBtn" class="neon" disabled>Download VCF</button>
        <div class="muted" id="countdownText" style="margin-top:.4rem">Unlocks in <span id="countdown">--:--:--</span></div>
      </section>

      <section class="card locked" id="helpCard">
        <h2>Need help importing?</h2>
        <div class="row">
          <a href="https://files.catbox.moe/jivobd.mp4" target="_blank" rel="noopener"><button class="whatsapp-dark">Android Tutorial</button></a>
          <a href="https://files.catbox.moe/n8pr97.mp4" target="_blank" rel="noopener"><button class="whatsapp-dark">iPhone Tutorial</button></a>
        </div>
      </section>

    </div>
    <footer class="footer"><p class="muted">By Seyori • Need help? Chat me on WhatsApp.</p></footer>
  </div>

  <script>
    window.__DEPLOYED_AT__ = '2025-09-11T12:00:00+01:00'; 
    let LOCK_DURATION = 24*60*60*1000;
    (function(){
      const t = new URLSearchParams(location.search).get('test');
      const map = { '10s':10e3, '30s':30e3, '1m':60e3, '5m':300e3 };
      if (t && map[t]) LOCK_DURATION = map[t];
    })();

    const contactCount = document.getElementById('contactCount');
    const messageDiv   = document.getElementById('message');
    const joinLink     = document.getElementById('joinLink');
    const tgLink       = document.getElementById('tgLink');
    const verifyBtn    = document.getElementById('verifyBtn');
    const gateMsg      = document.getElementById('gateMsg');
    const step2        = document.getElementById('step2');
    const step3        = document.getElementById('step3');
    const helpCard     = document.getElementById('helpCard');

    const contactForm  = document.getElementById('contactForm');
    const numberEl     = document.getElementById('number');
    const nameEl       = document.getElementById('fullName');
    const saveBtn      = document.getElementById('saveBtn');

    const ccSelect         = document.getElementById('ccSelect');
    const customCodeWrap   = document.getElementById('customCodeWrap');
    const ccCustom         = document.getElementById('ccCustom');

    const downloadBtn   = document.getElementById('downloadBtn');
    const countdownText = document.getElementById('countdownText');

    const isValidName  = (name) => /^[a-zA-Z\s\-.,'\"()]+$/.test((name||'').trim());
    const isValidPhone = (n)    => /^\d+$/.test(String(n||'').trim());
    function showMessage(text, type){
      messageDiv.innerHTML = `<div class="${type}">${text}</div>`;
      setTimeout(()=> messageDiv.innerHTML = '', 3000);
    }

    const COUNTRY_CODES = [
      {iso:'NG',name:'Nigeria',code:'234',flag:'🇳🇬'},
      {iso:'AF',name:'Afghanistan',code:'93',flag:'🇦🇫'},
      {iso:'AL',name:'Albania',code:'355',flag:'🇦🇱'},
      {iso:'DZ',name:'Algeria',code:'213',flag:'🇩🇿'},
      {iso:'AD',name:'Andorra',code:'376',flag:'🇦🇩'},
      {iso:'AO',name:'Angola',code:'244',flag:'🇦🇴'},
    ];
    function populateCountrySelect(){
      ccSelect.innerHTML = '';
      const customOpt = document.createElement('option');
      customOpt.value = 'custom';
      customOpt.textContent = '✏️  Custom code (enter manually)';
      customOpt.setAttribute('data-iso','XX');
      ccSelect.appendChild(customOpt);
      COUNTRY_CODES.forEach(c=>{
        const opt = document.createElement('option');
        opt.value = c.code;
        opt.textContent = `${c.flag} ${c.name} (+${c.code})`;
        opt.setAttribute('data-iso', c.iso);
        ccSelect.appendChild(opt);
      });
    }
    function detectRegionISO(){
      try{
        if (window.Intl && Intl.Locale){
          const loc = new Intl.Locale(navigator.language || (navigator.languages && navigator.languages[0]) || 'en-NG');
          if (loc && loc.region) return loc.region.toUpperCase();
        }
      }catch(e){}
      const tz = (Intl.DateTimeFormat().resolvedOptions().timeZone||'').toLowerCase();
      if (tz.includes('lagos')) return 'NG';
      return 'NG';
    }
    function setDefaultCountry(){
      const iso = 'NG';
      const idx = Array.from(ccSelect.options).findIndex(o => (o.getAttribute('data-iso')||'') === iso);
      ccSelect.selectedIndex = idx >= 0 ? idx : 1;
      toggleCustomCode();
    }
    function toggleCustomCode(){
      if (ccSelect.value === 'custom'){
        customCodeWrap.style.display = 'block';
        ccCustom.required = true;
        ccCustom.focus();
      } else {
        customCodeWrap.style.display = 'none';
        ccCustom.required = false;
        ccCustom.value = '';
      }
    }
    ccSelect.addEventListener('change', toggleCustomCode);

    // ---- Per-button double verification (requires 2 WA + 2 TG clicks) ----
    const SS_WA_COUNT = 'seyori_join_clicks_wa';
    const SS_TG_COUNT = 'seyori_join_clicks_tg';
    sessionStorage.setItem(SS_WA_COUNT, '0');
    sessionStorage.setItem(SS_TG_COUNT, '0');
    const getWa = () => parseInt(sessionStorage.getItem(SS_WA_COUNT)||'0',10) || 0;
    const getTg = () => parseInt(sessionStorage.getItem(SS_TG_COUNT)||'0',10) || 0;
    const setWa = (n) => sessionStorage.setItem(SS_WA_COUNT, String(n));
    const setTg = (n) => sessionStorage.setItem(SS_TG_COUNT, String(n));

    let waLock=false, tgLock=false;
    const joinLink = document.getElementById('joinLink');
    const tgLinkEl = document.getElementById('tgLink');
    joinLink.addEventListener('click', ()=>{
      if (waLock) return;
      waLock = true;
      setWa(getWa()+1);
      setTimeout(()=>{ waLock=false; }, 300);
    });
    tgLinkEl.addEventListener('click', ()=>{
      if (tgLock) return;
      tgLock = true;
      setTg(getTg()+1);
      setTimeout(()=>{ tgLock=false; }, 300);
    });

    const verifyBtnEl = document.getElementById('verifyBtn');
    verifyBtnEl.addEventListener('click', ()=>{
      const wa = getWa();
      const tg = getTg();
      if (wa < 2 || tg < 2){
        gateMsg.innerHTML = '<span class="error">Join both groups twice each (WhatsApp ×2 and Telegram ×2), then verify again.</span>';
        return; 
      }
      unlockSections();
      gateMsg.innerHTML = '<span class="success">Verified! You can add your contact now.</span>';
    });

    function unlockSections(){
      [step2, step3, helpCard].forEach(sec => sec.classList.remove('locked'));
      [ccSelect, ccCustom, numberEl, nameEl, saveBtn].forEach(el => {
        el.disabled = false; el.setAttribute('aria-disabled','false');
      });
    }

    async function fetchJSONWithFallback(pathBase, opts){
      const paths = [pathBase, pathBase.endsWith('.js') ? pathBase : `${pathBase}.js`];
      for (const p of paths){
        try{
          const r = await fetch(p, opts);
          const text = await r.text();
          let data; try { data = JSON.parse(text); } catch { data = { raw:text }; }
          if (r.ok) return { ok:true, data };
        }catch(e){}
      }
      return { ok:false, data:{ error:'Network error' } };
    }

    async function loadContactCount(){
      const res = await fetchJSONWithFallback('/api/contacts', { method:'GET', cache:'no-store' });
      if (res.ok){
        const d = res.data || {};
        contactCount.textContent = (d.count!=null ? d.count : 0);
      }
    }

    /* notifications + lock */
    let downloadUnlocked = false;

    function lockSaveSectionAfterUnlock(){
      step2.classList.add('locked');
      [ccSelect, ccCustom, numberEl, nameEl, saveBtn].forEach(el=>{
        el.disabled = true;
        el.setAttribute('aria-disabled','true');
      });
    }

    function requestNotifyPermission(){
      if (!('Notification' in window)) return;
      if (Notification.permission === 'default'){
        Notification.requestPermission().catch(()=>{});
      }
    }

    function notifyUnlock(){
      if (!('Notification' in window)) return;
      if (Notification.permission === 'granted'){
        try{
          new Notification('Contacts file is ready 🎉', {
            body: 'You can download the VCF now.',
            icon: '/favicon.ico'
          });
        }catch(e){}
      }
    }

    contactForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      if (saveBtn.disabled) return;

      requestNotifyPermission();

      const fullName = nameEl.value;
      const number   = numberEl.value;
      let countryCode = (ccSelect.value === 'custom' ? (ccCustom.value||'') : (ccSelect.value||'')).replace(/\+/g,'').trim();

      if (!isValidName(fullName)){
        showMessage('Use letters, spaces, and simple punctuation only.', 'error'); return;
      }
      if (!isValidPhone(number) || !isValidPhone(countryCode)){
        showMessage('Phone numbers should be digits only.', 'error'); return;
      }

      saveBtn.disabled = true; saveBtn.textContent = 'Saving...';
      const res = await fetchJSONWithFallback('/api/contacts', {
        method:'POST',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify({ fullName, number, countryCode })
      });
      if (res.ok){
        showMessage('Saved! Thanks for adding your contact.', 'success');
        contactForm.reset();
        setDefaultCountry();
        loadContactCount();
      }else{
        showMessage(res.data.error || 'Could not save. Try again.', 'error');
      }
      saveBtn.disabled = false; saveBtn.textContent = 'Save contact';
    });

    function deployedAtMs(){ const t = Date.parse(window.__DEPLOYED_AT__||''); return Number.isFinite(t)?t:Date.now(); }
    function msToHMS(ms){ const total=Math.max(0,Math.floor(ms/1000));const h=String(Math.floor(total/3600)).padStart(2,'0');const m=String(Math.floor((total%3600)/60)).padStart(2,'0');const s=String(total%60).padStart(2,'0');return `${h}:${m}:${s}`; }
    function setDownloadEnabled(enabled){ downloadBtn.disabled=!enabled; downloadBtn.classList.toggle('disabled',!enabled); }

    function tickCountdown(){
      const unlockAt = deployedAtMs()+LOCK_DURATION;
      const remain = Math.max(0, unlockAt-Date.now());
      const parts = msToHMS(remain);

      // Re-query countdown span each tick so it never gets stale
      const countdownEl = document.getElementById('countdown');
      if (countdownEl) countdownEl.textContent = parts;

      const canDownload = remain===0;
      setDownloadEnabled(canDownload);

      // Show ready message again on unlock
      countdownText.innerHTML = canDownload
        ? 'Ready! You can download now.'
        : 'Unlocks in <span id="countdown">'+parts+'</span>';

      if (canDownload && !downloadUnlocked){
        downloadUnlocked = true;
        lockSaveSectionAfterUnlock();
        notifyUnlock();
      }
    }

    downloadBtn.addEventListener('click', ()=>{ if (!downloadBtn.disabled) location.href='/api/export.js'; });

    populateCountrySelect();
    setDefaultCountry();
    loadContactCount();
    tickCountdown();
    setInterval(tickCountdown, 1000);
  </script>
</body>
</html>
